local uis = game:GetService("UserInputService")
local rs = game:GetService("ReplicatedStorage")
local lp = game:GetService("Players").LocalPlayer

local ability = rs:WaitForChild("GeneralAbility")
local muck = rs:WaitForChild("Events"):WaitForChild("Muck")
local retro = rs:WaitForChild("RetroAbility")

local function getClosestPlayer()
	local myRoot = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
	if not myRoot then return end

	local closest, dist = nil, math.huge
	for _, p in ipairs(game:GetService("Players"):GetPlayers()) do
		if p ~= lp and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
			local mag = (p.Character.HumanoidRootPart.Position - myRoot.Position).Magnitude
			if mag < dist then
				dist = mag
				closest = p
			end
		end
	end
	return closest
end

local function teleportBehind(target)
	local myChar = lp.Character
	local myRoot = myChar and myChar:FindFirstChild("HumanoidRootPart")
	local targetRoot = target and target.Character and target.Character:FindFirstChild("HumanoidRootPart")
	if not myRoot or not targetRoot then return end

	local offset = targetRoot.CFrame.LookVector * -3
	myRoot.CFrame = CFrame.new(targetRoot.Position + offset, targetRoot.Position)
end

local function addFireEffect()
	local char = lp.Character
	if not char then return end

	local glove = char:FindFirstChild("Glove") or char:FindFirstChild("RightHand") or char:FindFirstChildWhichIsA("Tool")
	if not glove or not glove:IsA("Tool") then return end

	local handle = glove:FindFirstChild("Handle") or glove:FindFirstChildWhichIsA("BasePart")
	if not handle then return end

	if not handle:FindFirstChild("BlueFire") then
		local fire = Instance.new("Fire")
		fire.Name = "BlueFire"
		fire.Color = Color3.fromRGB(0, 170, 255)
		fire.SecondaryColor = Color3.fromRGB(0, 85, 255)
		fire.Size = 8
		fire.Heat = 10
		fire.Parent = handle
	end

	if not handle:FindFirstChild("BlueLightning") then
		local lightning = Instance.new("ParticleEmitter")
		lightning.Name = "BlueLightning"
		lightning.Texture = "rbxassetid://26356442"
		lightning.Color = ColorSequence.new{
			ColorSequenceKeypoint.new(0, Color3.fromRGB(0, 170, 255)),
			ColorSequenceKeypoint.new(1, Color3.fromRGB(0, 85, 255))
		}
		lightning.LightEmission = 0.8
		lightning.Size = NumberSequence.new{
			NumberSequenceKeypoint.new(0, 0.3),
			NumberSequenceKeypoint.new(1, 0.1)
		}
		lightning.Transparency = NumberSequence.new(0.2)
		lightning.Speed = NumberRange.new(0, 0)
		lightning.Rate = 50
		lightning.Lifetime = NumberRange.new(0.2, 0.4)
		lightning.Rotation = NumberRange.new(0, 360)
		lightning.RotSpeed = NumberRange.new(-180, 180)
		lightning.ZOffset = 0.5
		lightning.Parent = handle
	end
end

local function renameGlove()
	local stats = lp:FindFirstChild("leaderstats")
	local gloveStat = stats and stats:FindFirstChild("Glove")
	if gloveStat and gloveStat:IsA("StringValue") then
		gloveStat.Value = "Frost God"
	end

	local backpack = lp:FindFirstChild("Backpack")
	if backpack then
		for _, tool in ipairs(backpack:GetChildren()) do
			if tool:IsA("Tool") and tool.Name == "Frostbite" then
				tool.Name = "Frost God"
			end
		end
	end

	local char = lp.Character
	if char then
		for _, tool in ipairs(char:GetChildren()) do
			if tool:IsA("Tool") and tool.Name == "Frostbite" then
				tool.Name = "Frost God"
			end
		end
	end
end

uis.InputBegan:Connect(function(input, gp)
	if gp then return end

	if input.KeyCode == Enum.KeyCode.R then
		ability:FireServer(2)
	elseif input.KeyCode == Enum.KeyCode.T then
		muck:FireServer()
	elseif input.KeyCode == Enum.KeyCode.F then
		local target = getClosestPlayer()
		if target then
			teleportBehind(target)
			ability:FireServer(0.3)
			local args = {[1] = "Ban Hammer"}
			retro:FireServer(unpack(args))
		end
	end
end)

addFireEffect()
renameGlove()
